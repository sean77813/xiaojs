<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <title>主页</title>
    <style>
        .panel-detail{
            position:fixed;
            top:130px;
            right:0px;
            padding-bottom: 0px;
            margin-bottom: 0px;
            border: #999999 2px;
            border-radius:5px 0 0 5px;
            border:3px solid #D1D1D1;
            background-color: #ffffff;
        }
    </style>
    <script src="/js/common.js"></script>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">SEAN文件系统</a>
        </div>
        <div>
            <form class="navbar-form navbar-left" role="search">
                <div class="form-group">
                    <input type="text" class="form-control" placeholder="Search">
                </div>
                <button type="submit" class="btn btn btn-success">搜索</button>
            </form>
            <button type="button" class="btn btn-primary navbar-btn" data-toggle="modal" data-target="#myModal">
                上传文件
            </button>

            <!--<div  style="float: right;padding: 5px 5px ">-->
                <!--<span th:text="${username}"></span>-->
                <!--<img style="width: 45px;height:45px;" class="img-circle image-responsive" src="/images/avatar.jpeg" alt="头像"/>-->
                <!--<a href="/user/logout" class="btn btn-default">安全退出</a>-->
            <!--</div>-->

            <div class="dropdown pull-right" style="display: inline-block;">
                <img src="" style="width: 43px;height:43px;" data-toggle="dropdown" class="img-circle dropdown-toggle myAvatar">
                <ul class="dropdown-menu">
                    <li>
                        <div style="position: relative;border: 5px solid lightblue;width: 100px;height:100px;margin: 5px auto;border-radius: 50%;">
                            <img src="" class="myAvatar" alt="选择并上传头像" id="avatar_img"
                                 style="width: 90px;height: 90px;left:0;top: 0;border-radius: 50%;"/>
                                <input type="file" id="avatar_file" name="avatar_file"
                                   accept="image/jpg,image/png,image/gif"
                                   style="width: 100%;height:100%;opacity: 0;position: absolute;left:0;top: 0;"/>
                        </div>

                    </li>
                    <div style="height:15px;visibility:hidden;"></div>
                    <li><a href="#" style="display:block; text-align:center;" data-toggle="modal" data-target="#userInfoModal"><span class="text-primary" style="font-size: 16px;" th:text="${username}"></span></a></li>
                    <li class="divider"></li>
                    <li><a href="#" style="display:block; text-align:center;" onclick="editPwd()">修改密码</a></li>
                    <li class="divider"></li>
                    <li><a href="/user/logout" style="display:block; text-align:center;">安全退出</a></li>

                </ul>
            </div>

        </div>
    </div>
</nav>
<div style="padding: 0 10px;margin: 0 10px;">

    <!-- 个人文件 详细面板 -->
    <div class="panel-detail" id="panel-detail" style="width: 400px;height: 80%;z-index:99;">
        <div style="padding:5px;">
            <button type="button" class="btn-primary btn-xs" onclick="closeDetail('mypic')">关闭</button>
            <button type="button" class="btn btn-primary pull-right"  data-toggle="modal" data-target="#addLabelModal">添加标签</button>
        </div>
        <div style="height:10px;visibility:hidden;"></div>
        <div>
            <table id="fileinfo_private">
            </table>
        </div>
        <!--属性-->
        <!--<div>-->
            <!--<table id="propsList">-->
            <!--</table>-->
        <!--</div>-->
        <!--<div style="height:25px;visibility:hidden;"></div>-->

        <!--标签-->
        <div id="labelList_private">
        </div>
        <div style="height:25px;visibility:hidden;"></div>

        <!--日志-->
        <div id="private-logs_div" class="pre-scrollable" style=" height:250px; overflow:auto">
        </div>
    </div>


    <!-- 分享文件 详细面板 -->
    <div class="panel-detail" id="share-detail" style="width: 400px;height: 80%;z-index:99;">

        <div style="padding:5px;">
            <button type="button" class="btn-primary btn-xs" onclick="closeDetail('share')">关闭</button>
        </div>
        <div style="height:10px;visibility:hidden;"></div>

        <div>
            <p class="text-left" style="padding-left: 20px;">作者：<span id="td_author" class="text-primary"></span>
                &nbsp;&nbsp;|&nbsp;&nbsp; 分享时间：<span id="td_releasetime"></span></p>
        </div>
        <div style="height:15px;visibility:hidden;"></div>

        <div id="labelList_public">
        </div>
        <div style="height:15px;visibility:hidden;"></div>

        <ul class="nav nav-tabs">
            <li class="active">
                <a href="#record_tab" data-toggle="pill">下载记录</a>
            </li>
            <li><a href="#record_comment" data-toggle="pill">评论</a></li>
        </ul>


        <div class="tab-content">
            <div class="tab-pane fade in active" id="record_tab">
                <div style="height:5px;visibility:hidden;"></div>
                <!--日志-->
                <div id="public-logs_div" class="pre-scrollable" style=" height:60%; overflow:auto">
                </div>
                <div style="height:15px;visibility:hidden;"></div>
            </div>
            <div class="tab-pane fade" id="record_comment">


                <!-- 评论 -->
                <div style="height:5px;visibility:hidden;"></div>
                <div id="public-comment_div" class="pre-scrollable" style="height:70%; overflow:auto;padding-bottom: 0px;margin-bottom: 0px;">
                    <ul class="list-group" id="public_comment_ul">
                        <!--<li class="list-group-item">-->
                            <!--<table>-->
                                <!--<tr>-->
                                    <!--<td rowspan="2" valign="top">-->
                                        <!--<img src="/images/avatar.jpeg" style="width: 35px;height:35px;" class="img-circle dropdown-toggle"></td>-->
                                    <!--<td >-->
                                        <!--<span class="text-primary" style="padding-left: 5px;">admin:</span><span class="small">免费域名注册免费域名注册免费域名注免费域名注册</span>-->
                                    <!--</td>-->

                                <!--</tr>-->
                                <!--<tr>-->
                                    <!--<td valign="bottom">-->
                                        <!--<span class="text-left text-muted small">2019-12-06</span>-->
                                    <!--</td>-->
                                <!--</tr>-->
                            <!--</table>-->
                        <!--</li>-->
                    </ul>
                </div>

                <div class="input-group col-lg-12" style="padding: 0 30px 10px 10px;">
                    <input type="text" class="form-control" id="input_msg">
                    <span class="input-group-btn">
                        <button class="btn btn-primary" type="button" onclick="addComment()">评论</button>
                    </span>
                </div>

            </div>
        </div>

    </div>
    <ul id="myTab" class="nav nav-tabs">
        <li class="active">
            <a href="#home" data-toggle="tab">我的文件
            </a>
        </li>
        <li>
            <a href="#shareSpace" data-toggle="tab">分享空间
            </a>
        </li>
    </ul>

    <div id="myTabContent" class="tab-content">
        <div class="tab-pane fade in active" id="home">
            <div style="height:10px;visibility:hidden;"></div>
            <!--我的照片-->
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">我的照片</h3>
                </div>
                <div class="panel-body">
                    <div class="row" id="img_show"></div>
                </div>
            </div>

            <div class="panel panel-success">
                <div class="panel-heading">
                    <h3 class="panel-title">我的文件</h3>
                </div>
                <div class="panel-body">
                    开发中....
                </div>
            </div>

        </div>
        <div class="tab-pane fade" id="shareSpace">
            <div style="height:10px;visibility:hidden;"></div>
            <div class="panel panel-info" onload="initPPic()">
                <div class="panel-heading">
                    <h3 class="panel-title">分享图片</h3>
                </div>
                <div class="panel-body">
                    <div class="row" id="ppic_show"></div>
                </div>
            </div>

        </div>
    </div>

<div>
</div>
    <!-- 上传 模态框（Modal） -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel" style="width: 200px;display: inline-block;">
                        上传文件
                    </h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="margin-top: 2px;">
                        &times;
                    </button>
                </div>
                <div class="modal-body">

                    <iframe id="uploadFrame" name="uploadFrame" src="/html/uploadfile.html" width="100%" height="460px" frameborder="0">
                    </iframe>

                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <!--删除 模态框-->
    <div class="modal fade" id="delModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width: 300px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                    </button>
                    <h4 class="modal-title" id="delModalLabel">
                        删除文件
                    </h4>
                </div>
                <div class="modal-body">
                    确定删除吗?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="del_btn">
                        确认删除
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        取消
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!--详情 模态框（Modal） -->
    <div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="detailModalModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-hidden="true">×
                    </button>
                    <h4 class="modal-title" id="detailModalModalLabel">
                        文件详情
                    </h4>
                </div>
                <div class="modal-body">
                    <button class="btn btn-info">添加属性</button>
                    <form>
                        <input type="text" name=""/>
                        <input type="text" name=""/>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal">关闭
                    </button>
                    <button type="button" class="btn btn-primary">
                        提交更改
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!--分享 模态框-->
    <div class="modal fade" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width:400px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                    </button>
                    <h4 class="modal-title" id="shareModalLabel">
                        分享图片
                    </h4>
                </div>
                <div class="modal-body">
                    将图片分享给所有人
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="share_btn">
                        确认
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- 显示大图模态框 -->
    <div class="modal fade text-center" id="showImgModal">
        <div class="modal-dialog modal-lg" style="display: inline-block; width: auto;">
            <div class="modal-content">
                <img id="showImage" src="">
            </div>
        </div>
    </div>

    <!-- 添加标签模态框（Modal） -->
    <div class="modal fade" id="addLabelModal" tabindex="-1" role="dialog" aria-labelledby="addLabelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h5 class="modal-title" id="addLabelModalLabel">
                        添加标签
                    </h5>
                </div>
                <div class="modal-body">
                    <form role="form">
                        <div class="form-group">
                            <label for="input_labels">标签内容</label>
                            <input type="text" class="form-control" id="input_labels" placeholder="添加多个标签用‘,’分隔">
                            <input type="hidden" name="addlabel_fileid" />
                        </div>
                        <label for="select_level">级别</label>
                        <select class="form-control" id="select_level">
                            <option >1</option>
                            <option>2</option>
                            <option selected>3</option>
                            <option>4</option>
                        </select>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addLabel()">
                        确认
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <!-- 用户个人信息模态框-->
    <div class="modal fade" id="userInfoModal" tabindex="-1" role="dialog" aria-labelledby="userInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width: 450px;">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-hidden="true">×
                    </button>
                    <h5 class="modal-title" id="userInfoModalLabel">
                        个人信息
                    </h5>
                </div>
                <div class="modal-body">
                    <form id="userinfo_form">
                    <table class="table">
                        <tbody>
                        <tr>
                            <td>
                                <img src="" style="width: 140px;height:140px;" data-toggle="dropdown" class="img-circle dropdown-toggle myAvatar">
                            </td>
                            <td>
                                <!--<button type="button" class="btn btn-link">更换头像</button>-->
                            </td>
                        </tr>
                        <tr>
                            <td><label for="firstname">账号：</label></td>
                            <td><input type="hidden" name="uid" id="info_uid"><span th:text="${username}"></span></td>
                        </tr>
                        <tr>
                            <td>
                                <label for="firstname" class="text-right control-label" >密码：</label>
                            </td>
                            <td>
                                <input type="password" re class="form-control" id="firstname"
                                       value="12345678a" readonly/>
                                <!--<button type="button" class="btn btn-link">修改密码</button>-->
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="info_actualname" class="control-label">真实姓名：</label>
                            </td>
                            <td>
                                <input type="text" class="form-control required" maxlength="8" id="info_actualname" name="actualname"/>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="info_phonenamber" class="control-label">手机号码：</label>
                            </td>
                            <td>
                                <input type="text" class="form-control" id="info_phonenamber" name="phonenamber" maxlength="11"/>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="info_age" class="control-label">年龄：</label>
                            </td>
                            <td>
                                <input type="text" class="form-control" id="info_age"  name="age" maxlength="3"/>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="info_sex" class="control-label">性别：</label>
                            </td>
                            <td>
                                <select class="form-control required" id="info_sex" name="sex">
                                    <option value="1" selected>男</option>
                                    <option value="0">女</option>
                                    <option value="-1">保密</option>
                                </select>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal">关闭
                    </button>
                    <button type="button" class="btn btn-primary" onclick="editUserInfo()">
                        提交更改
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->



<form action="/download" method="post" id="download_from">
    <input type="hidden"  name="filePath" id="download_filepath"/>
</form>
    <script>
        $(function () {
            //初始化个人图片
            initMyImg();
            //初始化分享图片
            initPPic();
            //初始化个人头像
            initMyAvatar();


            $('#delModal').modal('hide');
            //确认删除按钮
            $("#del_btn").on('click',function(){
                delfile(path);
            })
        });
        //点击图片下方 删除按钮
        $(document).on("click", "#del_btn_1", function(){
            $('#delModal').modal('show');
            path = $(this).next().val();
        });

        /** 显示文件 **/
        function initMyImg(){
            //清空图片
            $("#img_show").empty();
            $.post("/getMyfiles",{"filetype":"img"},function(data){
                console.log(data);
                var files = data.files;
                var img  = null;
                var l = files.length;
                for(var i=0;i<l;i++){
                    var img_path = null!=files[i].thumbimage ? files[i].thumbimage:files[i].path;
                    var $div = $("<div class='col-sm-6 col-md-2' style='width: 20%;height: 270px;'></div>");
                    var $a = $("<a href='#' onclick='showGigImg(\""+files[i].path+"\")' class='thumbnail' ></a>");
                    var $btn_dowload = $("<a href='#' class='btn btn-link' role='button' id='' onclick='downloadfile(\""+files[i].path+"\")'>下载</a>");
                    var $btn_del = $("<a href='#' class='btn btn-link' role='button' data-toggle='modal' id='del_btn_1'>删除</a>");
                    var $input = $("<input type='hidden' name='filepath' value='"+files[i].path+"'/>");
                    var $btn_share = $("<a href='' class='btn btn-link' role='button' data-toggle='modal' id='del_share' onclick='openShareModal(\""+files[i].id+"\")'>分享</a>");
                    var $btn_detail = $("<a href='' class='btn btn-link' role='button' data-toggle='modal' onclick='openDetail(\""+files[i].id+"\",\"mypic\")'>更多</a>");
                    var $img = $("<img src='"+img_path+"' alt='' />");
                    $a.append($img);
                    $div.append($a);
                    $div.append($btn_dowload);
                    $div.append($btn_del);
                    $div.append($input);
                    $div.append($btn_share);
                    $div.append($btn_detail);
                    $("#img_show").append($div);
                }
            }, 'json');
        }
        /**显示分享的图片**/
        function initPPic(){
            //清空图片
            $("#ppic_show").empty();
            $.post("/getPPic",{},function(data){
                console.log(data);
                var files = data.files;
                var img  = null;
                var l = files.length;
                for(var i=0;i<l;i++){
                    var img_path = null!=files[i].thumbimage ? files[i].thumbimage:files[i].path;
                    var $div = $("<div class='col-sm-6 col-md-2' style='width: 20%;height: 270px;'></div>");
                    var $a = $("<a href='#' onclick='showGigImg(\""+files[i].path+"\")' class='thumbnail'></a>");
                    var $btn_dowload = $("<a href='#' class='btn btn-link' role='button' id='' onclick='downloadfile(\""+files[i].path+"\")'>下载</a>");
                    var $btn_detail = $("<a href='#' class='btn btn-link' role='button' data-toggle='modal' onclick='openDetail(\""+files[i].id+"\",\"share\")'>更多</a>");
                    var $img = $("<img src='"+img_path+"' alt='' />");
                    $a.append($img);
                    $div.append($a);
                    $div.append($btn_dowload);
                    $div.append($btn_detail);
                    $("#ppic_show").append($div);
                }
            }, 'json');
        }

        var path = null;
        /** 删除图片 **/
        var delfile = function(path){
            console.log(path);
            $.ajax({
                url:"/deleteFile",//后台的接口地址
                type:"post",//post请求方式
                async: false,
                data: {"fileName":"fileName","filePath":path},//提交的数
                success:function (data) {
                    alert(data.msg);
                    $('#delModal').modal('hide')
                    location.reload();
                },error:function () {
                    alert("操作失败~");
                    $('#delModal').modal('hide')
                }
            })
        }
        /** 下载图片 **/
        var downloadfile = function(path){
            $("#download_filepath").val(path);
            $("#download_from").submit();
        }

        /*****  显示大图 *****/
        function showGigImg(path){
            $("#showImage").attr("src", path);
            $('#showImgModal').modal('show');
        }

    /***** 文件详细页 *******/
    $(function(){
        $("#panel-detail").hide();
        $("#share-detail").hide();

        //切换选项卡时隐藏详细面板
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            $("#panel-detail").hide();
            $("#share-detail").hide();
        });
    })
        //关闭详细面板
        function closeDetail(type){
            if("mypic"==type){
                $("#panel-detail").hide();
            }else if("share"==type){
                $("#share-detail").hide();
            }
        }
     var getPropJson = function(){
        var json;
        $.ajax({
            url:"/getExtPropJson",//后台的接口地址
            type:"post",//post请求方式
            async: false,
            data: {},//提交的数
            success:function (data) {
                console.log(data);
                json = data;
            },error:function (e) {
                console.log(e.toString());
            }
        })
         return json;
    }
     var getfileProp = function(fileid){
        var json;
        $.ajax({
            url:"/getExtPropJson",//后台的接口地址
            type:"post",//post请求方式
            async: false,
            data: {},//提交的数
            success:function (data) {
                console.log(data);
                json = data;
            },error:function (e) {
                console.log(e.toString());
            }
        })
         return json;
    }

        //打开详细
        function openDetail(fid,type){
            selecdfid = fid;
            if("mypic"==type){
                initfileLabel(fid,type);
                initFileLogs(fid,2,"false","private-logs_div"); //下载日志
                $("#panel-detail").show();
                //加载 标签fid
            }else if("share"==type){
                initfileLabel(fid,type);
                initFileLogs(fid,2,"false","public-logs_div"); //下载日志
                getComment(fid);
                $("#share-detail").show();
                $.ajax({
                    url:"/getPPicPropByFid",//后台的接口地址
                    type:"post",//post请求方式
                    async: false,
                    data: {"fileid":fid},//提交的数
                    success:function (data) {
                        var ppic = data.ppic;
                        console.log(data);
                        for(var i in ppic){
                            $("#td_"+i).html(ppic[i]);
                        }
                        $("#td_releasetime").html(resolvingDate(ppic.releasetime));
                    },error:function (e) {
                        console.log(e.toString());
                    }
                })
            }


        }

        /******** 图片分享 *********/
        var selecdfid; //选中的文件id
        function openShareModal(fid){
            if(""== fid || null == fid){
                alert("异常！");
                return;
            }
            $('#shareModal').modal('show');
            selecdfid = fid;
        }
        $(document).on("click", "#share_btn", function(){
            if(""== selecdfid || null == selecdfid){
                alert("异常！");
                return;
            }
            sharePIC(selecdfid);
        });
        //分享图片方法
        function sharePIC(fid){
            $.ajax({
                url:"/sharepic",//后台的接口地址
                type:"post",//post请求方式
                async: false,
                data: {"fileid":fid},//提交的数据
                success:function (resultCode) {
                    if("200"==resultCode){
                        alert("分享成功！");
                    }else if("400"==resultCode){
                        alert("参数异常！");
                    }else if("401"==resultCode){
                        alert("该图片已分享！");
                    }else if("404"==resultCode){
                        alert("图片源异常！");
                    }else if("500"==resultCode){
                        alert("分享异常！");
                    }
                    $('#shareModal').modal('hide');
                    initPPic();
                },error:function (e) {
                    console.log(e.toString());
                }
            })
        }

        /******* 图片标签 ********/
        //加载图片标签
        function initfileLabel(fid,type){
            var labelList = null;
            if("mypic"==type){
                labelList = $("#labelList_private");
            }else if("share"==type){
                labelList = $("#labelList_public");
            }
            if(null==labelList)
                return;
            labelList.empty();
            $.ajax({
                url:"/getPPicLabelByFid",//后台的接口地址
                type:"post",//post请求方式
                async: false,
                data: {"fileid":fid},//提交的数据
                success:function (data) {
                    var labels_str = data.labels;
                    if(null !=labels_str && ""!=labels_str){
                    var labels = JSON.parse(labels_str);
                    for(var i in labels){
                        var $div_balel;
                        if("1"==labels[i]){
                            $div_balel = $('<h7 style="display: inline-block"><span class="label label-default">'+i+'</span></h7>');
                        }else if("2"==labels[i]){
                            $div_balel = $('<h6 style="display: inline-block"><span class="label label-success">'+i+'</span></h6>');
                        }else if("3"==labels[i]){
                            $div_balel = $('<h5 style="display: inline-block"><span class="label label-info">'+i+'</span></h5>');
                        }else{
                            $div_balel = $('<h4 style="display: inline-block"><span class="label label-warning">'+i+'</span></h4>');
                        }
                        labelList.append('&nbsp;');
                        labelList.append($div_balel);
                    }
                    }
                },error:function (e) {
                    console.log(e.toString());
                }
            })
        }
        //添加标签
        function addLabel(){
            var fid = selecdfid;
            var labels = $("#input_labels").val();
            var level = $("#select_level").val();
            if( ""==labels || null==labels){
                alert("请输入标签内容");
                return;
            }
            if(""==fid || null==fid){
                alert("参数异常");
                return;
            }
            $.ajax({
                url:"/addlabel",//后台的接口地址
                type:"post",//post请求方式
                async: false,
                data: {"fileid":fid,"labels":labels,"level":level},//提交的数据
                success:function (resultCode) {
                    if("200"==resultCode){
                        alert("添加成功！");
                        $("#input_labels").val("");
                        $("#select_level").val("3");
                        $("#addLabelModal").modal("hide");
                        initfileLabel(fid,"mypic");
                    }else if("400"==resultCode){
                        alert("参数异常！");
                    }else if("401"==resultCode){
                        alert("该图片已分享！");
                    }else if("404"==resultCode){
                        alert("图片源异常！");
                    }else if("500"==resultCode){
                        alert("添加异常！");
                    }
                },error:function (e) {
                    console.log(e.toString());
                }
            })
        }
    </script>
    <script>
        /**
         * 获取文件操作日志
         */
        function initFileLogs(fid, type,isLike,div_Id){
            var $div = $("#"+div_Id);
            if($div == null){
                console.log("未找到日志容器:"+div_Id);
                return;
            }
            $div.empty();
            $.post("/filelog/getlogs",{"fileid":fid,"type":type,"isLike":isLike},function(data){
                console.log(data);
                var logs = data.logs;
                var $Tab = $("<table class='table table-condensed small text-center'></table>");
                var $thrad = $("<thead><tr><td style='width: 33%;'>日期</td><td style='width: 33%;'>操作人员</td><td style='width: 33%;'>操作</td></tr></thead>");
                var $tbody = $("<tbody></tbody>");
                for(var i=0; i<logs.length; i++){
                    var type;
                    if(logs[i].type==1){
                        type = "上传";
                    }else if(logs[i].type==2){
                        type = "下载";
                    }
                    var $tr = $("<tr><td class='text-primary text-left' style='width: 33%;padding-left: 15px;'>"+logs[i].operator+"</td><td style='width: 33%;'>"+type+"</td><td style='width: 33%;'>"+resolvingDate(logs[i].time)+"</td></tr>");
                    $tbody.append($tr);
                }
                // $Tab.append($thrad);
                $Tab.append($tbody);
                $div.append($Tab);
            }, 'json');
        }

        /**
         * 获取评论
         * @param fid
         */
        function getComment(fid) {
            var $comment_ul=  $("#public_comment_ul");
            if($comment_ul == null){
                console.log("评论ul获取失败！")
                return;
            }
            if ( ""== fid ){
                console.log("获取评论失败！！")
                return;
            }
            $comment_ul.empty();
            $.post("/comment/getComment",{"fileid":fid},function(data){
                console.log(data);
                var comments = data.comments;
            for(var i=0; i<comments.length; i++ ){
                var userAvatar = getUserAvatar(comments[i].uid);
                var $img = $("<img src='"+userAvatar+"' style='width: 35px;height:35px;' class='img-circle dropdown-toggle'>");

                var $li = $("<li class='list-group-item'></li>");
                var  $tab = $("<table></table>");
                var $tr_a = $("<tr></tr>");
                var $td_a1 = $("<td rowspan='2' valign='top'></td>");
                var $td_a2 = $("<td></td>");
                var $span_user = $("<span class='text-primary' style='padding-left: 5px;'>"+comments[i].username+"：</span>")
                var $span_msg = $("<span class='small'>"+comments[i].msg+"</span>");
                var $tr_b = $("<tr></tr>");
                var $td_b1 = $("<td valign='bottom'></td>");
                var $time = $("<span class='text-left text-muted small'>"+resolvingDate(comments[i].time)+"</span>");

                $td_a1.append($img);
                $td_a2.append($span_user);
                $td_a2.append($span_msg);
                $tr_a.append($td_a1);
                $tr_a.append($td_a2);

                $td_b1.append($time);
                $tr_b.append($td_b1);

                $tab.append($tr_a);
                $tab.append($tr_b);

                $li.append($tab);
                $comment_ul.append($li);
            }

            }, 'json');
        }

        /**
         * 添加评论
         */
        function addComment(){
            var fid = selecdfid;
            if(null == fid || ""==fid){
                alert("参数异常！");
                return;
            }
            var msg = $("#input_msg").val(); //评论内容
            console.log(msg);
            msg = removeBlank(msg); //去空格
            if( "" ==msg){
                alert("评论不能为空！");
                return;
            }
            $("#input_msg").val("");
            $.ajax({
                url:"/comment/addComment",//后台的接口地址
                type:"post",//post请求方式
                async: false,
                data: {"fileid":fid,"msg":msg,"Tx_isIncognito":"false"},//提交的数据
                success:function (data) {
                    if(data.result){
                        alert("评论成功！");
                        getComment(fid);
                    }else{
                        alert("评论失败！");
                    }
                },error:function (e) {
                    console.log(e.toString());
                }
            })
        }


    </script>


    <script>
        // 头像预览
        $("#avatar_file").change(function () {
            // 获取上传文件对象
            var file = $(this)[0].files[0];
            // 读取文件URL
            var reader = new FileReader();
            reader.readAsDataURL(file);
            // 阅读文件完成后触发的事件
            reader.onload = function () {
                // 读取的URL结果：this.result
                $("#avatar_img").attr("src", this.result);
                //更换头像
                setAvarat();
            }
        });

        var myAvatar = "/images/avatar.jpeg"; //默认头像(一拳超人)
        //初始化个人头像
        function initMyAvatar(){
            $.post("/usetting/getUserAvatar",{},function(data){
                var img = data.avatar_img;
                if(""!=img && null!= img){
                    myAvatar = img;
                }
                $(".myAvatar").attr("src",myAvatar);
            }, 'json');
        }

        //获取用户头像
        var getUserAvatar = function(uid){
            var userAvatar = "/images/avatar.jpeg"
            $.ajax({
                url:"/usetting/getUserAvatar",//后台的接口地址
                type:"post",//post请求方式
                async: false, //同步请求
                data: {"uid":uid},//提交的数据
                success:function (data) {
                    var img = data.avatar_img;
                    if(""!=img && null!= img){
                        userAvatar = img;
                    }
                },error:function (e) {
                    console.log(e.toString());
                }
            })
            return userAvatar;
        }


        //更换头像
        function setAvarat(){
            var formData = new FormData();
            formData.append("avatar_file",$("#avatar_file")[0].files[0]);
            if(formData == null){
                console.log("更换头像图片获取异常！");
                return;
            }
            $.ajax({
                type: "post",//方法类型
                dataType: "json",//预期服务器返回的数据类型
                url: "/usetting/setAvatar",//url
                data : formData,
                processData : false, // 使数据不做处理
                contentType : false, // 不要设置Content-Type请求头
                success: function (data) {
                    if(""!=data.result){
                        console.log("更换头像成功！");
                        //重新加载个人头像
                        initMyAvatar();
                    }else{
                        console.log("更换头像失败！");
                    }
                },
                error : function() {
                    alert("异常！");
                }
            });
        }

        //显示用户信息面板时
        $('#userInfoModal').on('show.bs.modal', function () {
            getUserInfo();
        })
        /**
         * 获取用户信息
         */
        function getUserInfo(){
            $.ajax({
                type: "post",//方法类型
                dataType: "json",//预期服务器返回的数据类型
                url: "/usetting/getUserInfo",//url
                async: false,
                data: {},//提交的数
                success: function (data) {
                    console.log(data);//打印服务端返回的数据(调试用)
                    var user = data.user;
                    for (var i in user){
                        $("#info_"+i).val(user[i]);
                    }

                },
                error : function() {
                    alert("用户信息获取异常！");
                }
            });
        }

        /**
         * 修改用户信息
         */
        function editUserInfo(){
            var  data = $("#userinfo_form").serialize();
            $.ajax({
                type: "post",//方法类型
                dataType: "json",//预期服务器返回的数据类型
                url: "/usetting/edituserinfo",//url
                async: false,
                data: data,//提交的数
                success: function (data) {
                    console.log(data);//打印服务端返回的数据(调试用)
                    if (data.result) {
                        alert("修改成功！");
                        getUserInfo();
                    }else{
                        alert("修改失败！");
                    }
                },
                error : function() {
                    alert("异常！");
                }
            });
        }

        /**
         * 修改密码
         */
        function editPwd(){
            alert("开发中...");
        }
    </script>
</body>
</html>
